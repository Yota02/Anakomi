{% extends "base.html" %}

{% block content %}
<!-- Nouveau hero -->
<div class="hero">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center flex-column flex-md-row gap-3">
            <form method="get" action="{{ url_for('index') }}" class="flex-grow-1" style="max-width:720px;">
                <div class="d-flex gap-2">
                    <div class="input-group flex-grow-1">
                        <input type="search" name="q" class="form-control" placeholder="Rechercher un anime..." value="{{ request.args.get('q', '') }}">
                        <button class="btn btn-outline-secondary" type="submit"><i class="fas fa-search"></i> Rechercher</button>
                    </div>

                    <!-- Nouveau: select de tri (existant) -->
                    <select name="sort" class="form-select" style="max-width:220px;">
                        <option value="recent" {% if sort == 'recent' %}selected{% endif %}>Plus récent</option>
                        <option value="title_asc" {% if sort == 'title_asc' %}selected{% endif %}>Titre A → Z</option>
                        <option value="title_desc" {% if sort == 'title_desc' %}selected{% endif %}>Titre Z → A</option>
                        <option value="rating_desc" {% if sort == 'rating_desc' %}selected{% endif %}>Trier par note</option>
                    </select>

                    <!-- Ajout : boutons de tri rapide -->
                    {% set q = request.args.get('q','') %}
                    <div class="btn-group" role="group" aria-label="Tri rapide" style="white-space:nowrap;">
                        <a href="{{ url_for('index', q=q, sort='recent') }}"
                           class="{% if sort == 'recent' %}btn btn-primary{% else %}btn btn-outline-secondary{% endif %} btn-sm"
                           title="Trier par plus récent">Récent</a>
                        <a href="{{ url_for('index', q=q, sort='title_asc') }}"
                           class="{% if sort == 'title_asc' %}btn btn-primary{% else %}btn btn-outline-secondary{% endif %} btn-sm"
                           title="Trier par titre A→Z">A → Z</a>
                        <a href="{{ url_for('index', q=q, sort='title_desc') }}"
                           class="{% if sort == 'title_desc' %}btn btn-primary{% else %}btn btn-outline-secondary{% endif %} btn-sm"
                           title="Trier par titre Z→A">Z → A</a>
                        <a href="{{ url_for('index', q=q, sort='rating_desc') }}"
                           class="{% if sort == 'rating_desc' %}btn btn-primary{% else %}btn btn-outline-secondary{% endif %} btn-sm"
                           title="Trier par meilleure note">Top</a>
                    </div>
                </div>
            </form>
            <div class="ms-md-3">
                {% if current_user %}
                    <a href="{{ url_for('add_anime') }}" class="btn btn-brand btn-lg">Ajouter un anime</a>
                {% else %}
                    <a href="{{ url_for('login') }}" class="btn btn-outline-primary btn-lg">Se connecter</a>
                {% endif %}
            </div>
        </div>
    </div> 
</div>

<h1 class="mb-4">Liste des Animes</h1>

<div class="row">
    {% for anime in animes %}
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            {% if anime.cover_url %}
            <img src="{{ anime.cover_url }}" class="card-img-top" alt="{{ anime.title }}" style="height: 220px; object-fit: cover;">
            {% else %}
            <div class="card-img-top d-flex align-items-center justify-content-center bg-light" style="height: 220px;">
                <i class="fas fa-image fa-3x text-muted"></i>
            </div>
            {% endif %}
            <div class="card-body d-flex flex-column">
                <h5 class="card-title">{{ anime.title }}</h5>

                {# Affichage de la note moyenne et des étoiles #}
                <div class="mb-2">
                    {% set avg = (anime.avg_rating or 0) %}
                    {% set avg_int = avg|int %}
                    <div class="d-flex align-items-center gap-2">
                        <div>
                            {% for i in range(1, 6) %}
                                {% if i <= avg_int %}
                                    <i class="fas fa-star text-warning"></i>
                                {% elif i == avg_int + 1 and (avg - avg_int) >= 0.5 %}
                                    <i class="fas fa-star-half-alt text-warning"></i>
                                {% else %}
                                    <i class="far fa-star text-warning"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <small class="text-muted">{{ '%.1f'|format(avg) }}/5 · {{ anime.review_count or 0 }} avis</small>
                    </div>
                </div>

                <p class="card-text text-muted" style="flex:1;">{{ (anime.description[:120] ~ '...') if anime.description else '' }}</p>
                <p class="text-muted small mb-2">Genre: {{ anime.genre or '—' }} · Année: {{ anime.year or '—' }}</p>
                <div class="mt-auto d-flex gap-2">
                    <a href="{{ url_for('anime_detail', id=anime.id) }}" class="btn btn-primary flex-grow-1">Voir</a>
                    {% if current_user %}
                        <a href="{{ url_for('edit_anime', id=anime.id) }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-edit"></i>
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% if not animes %}
<div class="text-center py-5">
    <h3>Aucun anime pour le moment</h3>
    {% if current_user %}
        <a href="{{ url_for('add_anime') }}" class="btn btn-brand mt-3">Ajouter le premier anime</a>
    {% endif %}
</div>
{% endif %}
{% endblock %}
